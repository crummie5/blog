<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns#" lang="en">

<head>
  <link rel="icon" type="image/png" href="https://www.crummie5.club/favicon.ico" />
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.crummie5.club/rss.xml">
  
  <link rel="stylesheet" href="https://www.crummie5.club/main.css">
  

  <link href="https://fonts.googleapis.com/css?family=Ubuntu&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700&display=swap" rel="stylesheet">

  <script src="https://www.crummie5.club/elasticlunr.min.js"></script>
  <script src="https://www.crummie5.club/search_index.en.js"></script>
  <script src="https://www.crummie5.club/search.js"></script>
  <script>'https:' !== window.location.protocol && (window.location.protocol = 'https')</script>
  
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta property="og:site_name" content="Crummie5">
  <meta name="robots" content="index, nofollow">
  <meta name="language" content="English">

  
  <title>Crummie5</title>
  <meta property="og:type" content="web">
  <meta property="og:url" content="https://www.crummie5.club/">
  <meta property="og:image" content="https://www.crummie5.club/foca.jpg">
  <meta property="og:title" content="Crummie5">
  <meta property="og:description" content="Just a crummy blog. Talking about Active Directory, Windows, Linux, Web and General Hacking.">
  <meta name="description" content="Just a crummy blog. Talking about Active Directory, Windows, Linux, Web and General Hacking.">
  

</head>


<body>
  <div class="header_container">
    <header>
      <img src="https://www.crummie5.club/logo.png" class="logo-img" alt="just a foca">
      <h1 class="logo-title"><a href="https://www.crummie5.club">Crummie5</a></h1>
    </header>
     <div class="menu-container">
      <ul class="menu">
        <li class="menu-element"><a href="https://www.crummie5.club">home</a></li>
        <li class="menu-element"><a href="https://www.crummie5.club/about">about us</a></li>
        <li class="menu-element dropdown-container">
          <label for="tags">tags</label>
          <input id="tags" class="tags-toggle" type="checkbox" style="display:none" value="0">
          <div class="dropdown">
            <ul class="submenu">
              <li class="submenu-element">
                <a href="https://www.crummie5.club/tags/linux">Linux</a>
              </li>
              <li class="submenu-element">
                <a href="https://www.crummie5.club/tags/windows">Windows</a>
              </li> 
              <li class="submenu-element">
                <a href="https://www.crummie5.club/tags/malware">Malware</a>
              </li>
              <li class="submenu-element">
                <a href="https://www.crummie5.club/tags">View All</a>
              </li>
            </ul>
          </div>
        </li>
        <div class="search_bar_container menu-element">
          <input type="text" placeholder="Search..." class="search_bar">
          <div class="search-results">
            <div class="search-results__items"></div>
          </div>
        </div>
      </ul>
    </div>
    <div class="search_bar_container mobile">
      <input type="text" placeholder="Search..." class="search_bar">
      <div class="search-results">
        <div class="search-results__items mobile"></div>
      </div>
    </div>
  </div>

  
  <div class="posts_container">
    <h1 class="recent-posts">Recent Posts</h1>
    
    

<div class="post">
    <h1>
        <a class="post-title" href="https://www.crummie5.club/freshycalls/">FreshyCalls: Syscalls Freshly Squeezed!</a>
    </h1>
    <div class="post-data">
        

<b>ElephantSe4l</b> on 2020-06-10 &nbsp;·&nbsp;

<svg viewBox="0 0 32 32" width="16" height="16" fill="none" stroke="currentcolor" stroke-linecap="round"
    stroke-linejoin="round" stroke-width="6.25%" preserveAspectRatio="xMaxYMax">
    <circle cx="16" cy="16" r="14" />
    <path d="M16 8 L16 16 20 20" />
</svg>
6 minutes read
<br>

<svg class="tag-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="16" height="16" fill="none"
    stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
    <circle cx="24" cy="8" r="2" />
    <path d="M2 18 L18 2 30 2 30 14 14 30 Z" />
</svg>





<a class="post-data-tag" href="https://www.crummie5.club/tags/windows/">#Windows&nbsp;</a>





·&nbsp;


<a href="https://twitter.com/intent/tweet?text=FreshyCalls%3A%20Syscalls%20Freshly%20Squeezed%21%3A%20FreshyCalls%20is%20a%20library%20that%20tries%20to%20make%20the%20use%20of%20syscalls%20comfortable%20and%20simple%2C%20without%20generating%20too%20much%20boilerplate%20and%20in%20modern%20C%2B%2B%21%0A&url=https://www.crummie5.club/freshycalls/">
    <svg id="i-twitter" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="32" height="32"
        style="width:1.2rem;height:1.2rem">
        <path stroke-width="0" fill="currentColor"
            d="M60 16 L54 17 L58 12 L51 14 C42 4 28 15 32 24 C16 24 8 12 8 12 C8 12 2 21 12 28 L6 26 C6 32 10 36 17 38 L10 38 C14 46 21 46 21 46 C21 46 15 51 4 51 C37 67 57 37 54 21 Z" />
    </svg>
</a>

<a
    href="https://www.linkedin.com/shareArticle?mini=true&title=FreshyCalls%3A%20Syscalls%20Freshly%20Squeezed%21%3A%20FreshyCalls%20is%20a%20library%20that%20tries%20to%20make%20the%20use%20of%20syscalls%20comfortable%20and%20simple%2C%20without%20generating%20too%20much%20boilerplate%20and%20in%20modern%20C%2B%2B%21%0A&url=https://www.crummie5.club/freshycalls/">
    <svg id="i-linkedin" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32"
        style="width:1.3rem;height:1.3rem">
        <rect height="11" width="4" x="3" y="9"></rect>
        <circle cx="5" cy="5" r="2"></circle>
        <path
            d="M16.5,8.25A4.47251,4.47251,0,0,0,13,9.95343V9H9V20h4V13a2,2,0,0,1,4,0v7h4V12.75A4.5,4.5,0,0,0,16.5,8.25Z">
        </path>
    </svg>
</a>

<a href="https://telegram.me/share/?text=%0AFreshyCalls%3A%20Syscalls%20Freshly%20Squeezed%21%3A%20FreshyCalls%20is%20a%20library%20that%20tries%20to%20make%20the%20use%20of%20syscalls%20comfortable%20and%20simple%2C%20without%20generating%20too%20much%20boilerplate%20and%20in%20modern%20C%2B%2B%21&url=https://www.crummie5.club/freshycalls/">
    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 1000 1000"
        width="32" height="32" style="width:1.1rem;height:1.1rem">
        <path
            d="M500,10C229.4,10,10,229.4,10,500s219.4,490,490,490s490-219.4,490-490S770.6,10,500,10z M740.8,345.9l-80.4,378.8c-5.5,27-21.8,33.3-44.4,20.9L493.5,655l-58.8,57.2c-6.9,6.7-12.3,12.3-24.5,12.3c-15.9,0-13.2-5.9-18.6-21.1l-41.7-137l-121.2-37.7c-26.2-8-26.4-26,5.9-38.9l472-182.2C728.2,297.9,749,312.8,740.8,345.9L740.8,345.9z" />
    </svg>
</a>


    </div>
    <div class="post-summary">
        <p>These last months I've been familiarizing myself with Windows syscalls: how they work, their offensive usage and potential detections from the blue side. Although the theory was quite interesting, I had to get my hands on it. </p>
<p>I started with the basics: static syscalls for my version of Windows. </p>
<p>As I'm not a pentester - I'm a programmer - I found it too uncomfortable to have to define each syscall each time. That's why I made a list with all the syscall numbers and a template that mapped each syscall with each number in a global variable. </p>
<p>It was something like this:</p>
<p>syscall.asm:</p>
<pre style="background-color:#2b2c2f;">
<span style="color:#6699cc;">EXTERN syscall_no:DWORD</span><span style="color:#cccece;">
</span><span style="color:#cccece;">
</span><span style="color:#6699cc;">.code</span><span style="color:#cccece;">
</span><span style="color:#cccece;">
</span><span style="color:#6699cc;">call_syscall PROC</span><span style="color:#cccece;">
    </span><span style="color:#c594c5;">mov </span><span style="color:#f99157;">r10</span><span style="color:#cccece;">, </span><span style="color:#f99157;">rcx</span><span style="color:#cccece;">
    </span><span style="color:#c594c5;">mov </span><span style="color:#f99157;">eax</span><span style="color:#cccece;">, </span><span style="color:#6699cc;">syscall_no</span><span style="color:#cccece;">
    </span><span style="color:#c594c5;">syscall</span><span style="color:#cccece;">
    </span><span style="color:#c594c5;">ret</span><span style="color:#cccece;">
</span><span style="color:#6699cc;">call_syscall ENDP</span><span style="color:#cccece;">
</span><span style="color:#cccece;">
</span><span style="color:#6699cc;">END</span><span style="color:#cccece;">
</span></pre>
<p>syscall.cpp:</p>
<pre style="background-color:#2b2c2f;">
<span style="color:#c594c5;">extern </span><span style="color:#5fb3b3;">&quot;</span><span style="color:#99c794;">C</span><span style="color:#5fb3b3;">&quot; </span><span style="color:#fac863;">DWORD</span><span style="color:#cccece;"> syscall_no </span><span style="color:#5fb3b3;">= </span><span style="color:#f99157;">0</span><span style="color:#5fb3b3;">;</span><span style="color:#c594c5;">
extern </span><span style="color:#5fb3b3;">&quot;</span><span style="color:#99c794;">C</span><span style="color:#5fb3b3;">&quot; </span><span style="color:#c594c5;">void</span><span style="color:#5fb3b3;">* </span><span style="color:#6699cc;">call_syscall</span><span style="color:#5fb3b3;">(...);</span><span style="color:#cccece;">
</span><span style="color:#cccece;">
</span><span style="color:#5fb3b3;">[...]</span><span style="color:#cccece;">
</span><span style="color:#cccece;">
</span><span style="color:#fac863;">DWORD</span><span style="color:#cccece;"> syscall_no </span><span style="color:#5fb3b3;">=</span><span style="color:#cccece;"> syscalls</span><span style="color:#5fb3b3;">.</span><span style="color:#6699cc;">find</span><span style="color:#5fb3b3;">(&quot;</span><span style="color:#99c794;">NtReadVirtualMemory</span><span style="color:#5fb3b3;">&quot;);</span><span style="color:#cccece;">
</span><span style="color:#6699cc;">call_syscall</span><span style="color:#5fb3b3;">(</span><span style="color:#6699cc;">h_process</span><span style="color:#5fb3b3;">,</span><span style="color:#6699cc;"> mem_addr</span><span style="color:#5fb3b3;">, &amp;</span><span style="color:#6699cc;">buf</span><span style="color:#5fb3b3;">,</span><span style="color:#6699cc;"> mem_size</span><span style="color:#5fb3b3;">, </span><span style="color:#f99157;">nullptr</span><span style="color:#5fb3b3;">);</span><span style="color:#cccece;">
</span></pre>
        <a class="readmore" href="https://www.crummie5.club/freshycalls/">Read more...&nbsp;&raquo;</a>
    </div>
</div>


    
    

<div class="post">
    <h1>
        <a class="post-title" href="https://www.crummie5.club/kerberos-unconstrained-tgt/">Kerberos Unconstrained Delegation: Compromising a Computer Object by its TGT</a>
    </h1>
    <div class="post-data">
        

<b>ATTL4S</b> on 2020-04-12 &nbsp;·&nbsp;

<svg viewBox="0 0 32 32" width="16" height="16" fill="none" stroke="currentcolor" stroke-linecap="round"
    stroke-linejoin="round" stroke-width="6.25%" preserveAspectRatio="xMaxYMax">
    <circle cx="16" cy="16" r="14" />
    <path d="M16 8 L16 16 20 20" />
</svg>
6 minutes read
<br>

<svg class="tag-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="16" height="16" fill="none"
    stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
    <circle cx="24" cy="8" r="2" />
    <path d="M2 18 L18 2 30 2 30 14 14 30 Z" />
</svg>





<a class="post-data-tag" href="https://www.crummie5.club/tags/windows/">#Windows&nbsp;</a>



<a class="post-data-tag" href="https://www.crummie5.club/tags/active-directory/">#Active Directory&nbsp;</a>



<a class="post-data-tag" href="https://www.crummie5.club/tags/privilege-escalation/">#Privilege Escalation&nbsp;</a>





·&nbsp;


<a href="https://twitter.com/intent/tweet?text=Kerberos%20Unconstrained%20Delegation%3A%20Compromising%20a%20Computer%20Object%20by%20its%20TGT%3A%20In%20this%20post%20we%20will%20see%20how%20to%20abuse%20Kerberos%20Unconstrained%20Delegation%20to%20compromise%20systems%20by%20impersonating%20their%20associated%20computer%20accounts.%0A&url=https://www.crummie5.club/kerberos-unconstrained-tgt/">
    <svg id="i-twitter" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="32" height="32"
        style="width:1.2rem;height:1.2rem">
        <path stroke-width="0" fill="currentColor"
            d="M60 16 L54 17 L58 12 L51 14 C42 4 28 15 32 24 C16 24 8 12 8 12 C8 12 2 21 12 28 L6 26 C6 32 10 36 17 38 L10 38 C14 46 21 46 21 46 C21 46 15 51 4 51 C37 67 57 37 54 21 Z" />
    </svg>
</a>

<a
    href="https://www.linkedin.com/shareArticle?mini=true&title=Kerberos%20Unconstrained%20Delegation%3A%20Compromising%20a%20Computer%20Object%20by%20its%20TGT%3A%20In%20this%20post%20we%20will%20see%20how%20to%20abuse%20Kerberos%20Unconstrained%20Delegation%20to%20compromise%20systems%20by%20impersonating%20their%20associated%20computer%20accounts.%0A&url=https://www.crummie5.club/kerberos-unconstrained-tgt/">
    <svg id="i-linkedin" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32"
        style="width:1.3rem;height:1.3rem">
        <rect height="11" width="4" x="3" y="9"></rect>
        <circle cx="5" cy="5" r="2"></circle>
        <path
            d="M16.5,8.25A4.47251,4.47251,0,0,0,13,9.95343V9H9V20h4V13a2,2,0,0,1,4,0v7h4V12.75A4.5,4.5,0,0,0,16.5,8.25Z">
        </path>
    </svg>
</a>

<a href="https://telegram.me/share/?text=%0AKerberos%20Unconstrained%20Delegation%3A%20Compromising%20a%20Computer%20Object%20by%20its%20TGT%3A%20In%20this%20post%20we%20will%20see%20how%20to%20abuse%20Kerberos%20Unconstrained%20Delegation%20to%20compromise%20systems%20by%20impersonating%20their%20associated%20computer%20accounts.&url=https://www.crummie5.club/kerberos-unconstrained-tgt/">
    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 1000 1000"
        width="32" height="32" style="width:1.1rem;height:1.1rem">
        <path
            d="M500,10C229.4,10,10,229.4,10,500s219.4,490,490,490s490-219.4,490-490S770.6,10,500,10z M740.8,345.9l-80.4,378.8c-5.5,27-21.8,33.3-44.4,20.9L493.5,655l-58.8,57.2c-6.9,6.7-12.3,12.3-24.5,12.3c-15.9,0-13.2-5.9-18.6-21.1l-41.7-137l-121.2-37.7c-26.2-8-26.4-26,5.9-38.9l472-182.2C728.2,297.9,749,312.8,740.8,345.9L740.8,345.9z" />
    </svg>
</a>


    </div>
    <div class="post-summary">
        <p>Everything that involves Kerberos functionality is such a complex subject… since I’ve been abusing these attack chains a lot recently, I thought this post would be helpful to someone.</p>
<p><strong>NOTE:</strong> Nothing explained here is new at all. If you understand how Delegations work you may be already aware of these vectors. Nonetheless it might not be as straight forward for everyone, hence I’m writing this.</p>
<p>If you are not familiar with Kerberos Delegation, you can find some links in the References section as I don’t feel necessary to explain what is already perfectly explained by others.</p>
<h2 id="introduction">Introduction<a class="zola-anchor" href="#introduction" aria-label="Anchor link for: introduction">
    <svg id="i-link" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="32" height="32" fill="none"
        stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
        <path
            d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15">
        </path>
    </svg>
</a>
</h2>
<p>Ok let’s asume we've compromised <code>Web01.capsule.corp</code>, a server with Kerberos Unconstrained Delegation enabled:</p>
<figure>
  <img src="https://www.crummie5.club/kerberos-unconstrained-tgt//fig1.png" alt="Web01 configured with Unconstrained Delegation." />
  <figcaption>Web01 configured with Unconstrained Delegation.</figcaption>
</figure>

        <a class="readmore" href="https://www.crummie5.club/kerberos-unconstrained-tgt/">Read more...&nbsp;&raquo;</a>
    </div>
</div>


    
    

<div class="post">
    <h1>
        <a class="post-title" href="https://www.crummie5.club/pwning-a-pwned-citrix/">Pwning A Pwned Citrix</a>
    </h1>
    <div class="post-data">
        

<b>arcocap4z</b> on 2020-01-19 &nbsp;·&nbsp;

<svg viewBox="0 0 32 32" width="16" height="16" fill="none" stroke="currentcolor" stroke-linecap="round"
    stroke-linejoin="round" stroke-width="6.25%" preserveAspectRatio="xMaxYMax">
    <circle cx="16" cy="16" r="14" />
    <path d="M16 8 L16 16 20 20" />
</svg>
7 minutes read
<br>

<svg class="tag-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="16" height="16" fill="none"
    stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
    <circle cx="24" cy="8" r="2" />
    <path d="M2 18 L18 2 30 2 30 14 14 30 Z" />
</svg>





<a class="post-data-tag" href="https://www.crummie5.club/tags/linux/">#Linux&nbsp;</a>



<a class="post-data-tag" href="https://www.crummie5.club/tags/exploiting/">#Exploiting&nbsp;</a>



<a class="post-data-tag" href="https://www.crummie5.club/tags/malware/">#Malware&nbsp;</a>





·&nbsp;


<a href="https://twitter.com/intent/tweet?text=Pwning%20A%20Pwned%20Citrix%3A%20How%20what%20looked%20like%20a%20Citrix%20CVE-2019-19781%20mitigation%20ended%20up%20being%20the%20NOTROBIN%20Trojan%20protecting%20itself%20from%20being%20re-exploited.%20The%20journey%20of%20exploiting%20a%20race-condition%20to%20gain%20RCE.%0A&url=https://www.crummie5.club/pwning-a-pwned-citrix/">
    <svg id="i-twitter" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="32" height="32"
        style="width:1.2rem;height:1.2rem">
        <path stroke-width="0" fill="currentColor"
            d="M60 16 L54 17 L58 12 L51 14 C42 4 28 15 32 24 C16 24 8 12 8 12 C8 12 2 21 12 28 L6 26 C6 32 10 36 17 38 L10 38 C14 46 21 46 21 46 C21 46 15 51 4 51 C37 67 57 37 54 21 Z" />
    </svg>
</a>

<a
    href="https://www.linkedin.com/shareArticle?mini=true&title=Pwning%20A%20Pwned%20Citrix%3A%20How%20what%20looked%20like%20a%20Citrix%20CVE-2019-19781%20mitigation%20ended%20up%20being%20the%20NOTROBIN%20Trojan%20protecting%20itself%20from%20being%20re-exploited.%20The%20journey%20of%20exploiting%20a%20race-condition%20to%20gain%20RCE.%0A&url=https://www.crummie5.club/pwning-a-pwned-citrix/">
    <svg id="i-linkedin" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32"
        style="width:1.3rem;height:1.3rem">
        <rect height="11" width="4" x="3" y="9"></rect>
        <circle cx="5" cy="5" r="2"></circle>
        <path
            d="M16.5,8.25A4.47251,4.47251,0,0,0,13,9.95343V9H9V20h4V13a2,2,0,0,1,4,0v7h4V12.75A4.5,4.5,0,0,0,16.5,8.25Z">
        </path>
    </svg>
</a>

<a href="https://telegram.me/share/?text=%0APwning%20A%20Pwned%20Citrix%3A%20How%20what%20looked%20like%20a%20Citrix%20CVE-2019-19781%20mitigation%20ended%20up%20being%20the%20NOTROBIN%20Trojan%20protecting%20itself%20from%20being%20re-exploited.%20The%20journey%20of%20exploiting%20a%20race-condition%20to%20gain%20RCE.&url=https://www.crummie5.club/pwning-a-pwned-citrix/">
    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 1000 1000"
        width="32" height="32" style="width:1.1rem;height:1.1rem">
        <path
            d="M500,10C229.4,10,10,229.4,10,500s219.4,490,490,490s490-219.4,490-490S770.6,10,500,10z M740.8,345.9l-80.4,378.8c-5.5,27-21.8,33.3-44.4,20.9L493.5,655l-58.8,57.2c-6.9,6.7-12.3,12.3-24.5,12.3c-15.9,0-13.2-5.9-18.6-21.1l-41.7-137l-121.2-37.7c-26.2-8-26.4-26,5.9-38.9l472-182.2C728.2,297.9,749,312.8,740.8,345.9L740.8,345.9z" />
    </svg>
</a>


    </div>
    <div class="post-summary">
        <p><strong>Hello H4x0rs!</strong>
At this time you surely have heard about the new and dangerous Citrix vulnerability labeled as CVE-2019-19781, consisting in a Directory Traversal plus Remote Command Execution attack vector. During a real security engagement I had to face a peculiar situation related to this and I wanted to share it with you, hope you find it useful.</p>
<p>Just as a quick recap, CVE-2019-19781, also known as “Shitrix” takes advantage of how the Citrix Gateway appliance handles templates. You can create a template by making a call to the <code>/vpn/../vpns/portal/scripts/newbm.pl</code> endpoint and inserting some Perl template into an XML file. This one contains the payload, but it is not executed until a request is made to the <code>/vpn/../vpns/portal/&lt;xml_name&gt;.xml</code> endpoint, which is the action that triggers the command execution.</p>
<p>There are a few exploits available to the public that implements that process so that you only have to specify the target and press enter to get a shell. However none of these worked for me for a good reason that we are going to explore in the following lines.</p>

        <a class="readmore" href="https://www.crummie5.club/pwning-a-pwned-citrix/">Read more...&nbsp;&raquo;</a>
    </div>
</div>


    
  </div>
  

</body>

</html>
